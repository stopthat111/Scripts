# SSL/TLS Hardening Script (Non-Interactive, RDMS-Aware, with Post-Change Verification)

# Check for admin rights
If (-not ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole(`
    [Security.Principal.WindowsBuiltInRole] "Administrator")) {
    Write-Host "❌ Must run as administrator." -ForegroundColor Red
    exit 1
}

# Set log path
$logPath = "C:\ProgramData\NinjaRMMAgent\Logs\ssltls-fix-rdms-auto.log"
if (-not (Test-Path $logPath)) {
    New-Item -ItemType File -Path $logPath -Force | Out-Null
}

Function Get-ProtocolState {
    param ([string]$Protocol)
    $base = "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\$Protocol"
    $states = @{}

    foreach ($role in @("Client", "Server")) {
        $key = Join-Path $base $role
        $enabled = $null
        $disabledByDefault = $null

        if (Test-Path $key) {
            $enabled = (Get-ItemProperty -Path $key -Name Enabled -ErrorAction SilentlyContinue).Enabled
            $disabledByDefault = (Get-ItemProperty -Path $key -Name DisabledByDefault -ErrorAction SilentlyContinue).DisabledByDefault
        }

        $states["$role.Enabled"] = $enabled
        $states["$role.DisabledByDefault"] = $disabledByDefault
    }

    return $states
}

Function Set-ProtocolState {
    param (
        [string]$Protocol,
        [bool]$Enable
    )

    $base = "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\$Protocol"

    foreach ($role in @("Client", "Server")) {
        $key = Join-Path $base $role
        if (-not (Test-Path $key)) {
            New-Item -Path $key -Force | Out-Null
        }

        if ($Enable) {
            New-ItemProperty -Path $key -Name "Enabled" -Value 1 -PropertyType "DWord" -Force | Out-Null
            New-ItemProperty -Path $key -Name "DisabledByDefault" -Value 0 -PropertyType "DWord" -Force | Out-Null
        } else {
            New-ItemProperty -Path $key -Name "Enabled" -Value 0 -PropertyType "DWord" -Force | Out-Null
            New-ItemProperty -Path $key -Name "DisabledByDefault" -Value 1 -PropertyType "DWord" -Force | Out-Null
        }

        Add-Content -Path $logPath -Value "$(Get-Date -Format u) - Modified ${Protocol} ($role): Enabled=$Enable"
    }
}

Function Is-RDMSInstalled {
    try {
        $roles = Get-WindowsFeature | Where-Object { $_.Installed -eq $true }
        return $roles.Name -contains "RDS-Connection-Broker" -or
               $roles.Name -contains "RDS-Web-Access" -or
               $roles.Name -contains "RDS-Gateway"
    } catch {
        Write-Host "⚠️ Unable to detect RDMS roles." -ForegroundColor Yellow
        return $false
    }
}

# Determine TLS 1.0 status based on RDMS presence
$rdmsPresent = Is-RDMSInstalled
$tls10State = $false
if ($rdmsPresent) {
    Write-Host "⚠️ RDMS detected. TLS 1.0 will remain ENABLED." -ForegroundColor Yellow
    $tls10State = $true
} else {
    Write-Host "✅ No RDMS roles detected. TLS 1.0 will be DISABLED." -ForegroundColor Green
}

# Define desired states
$desiredStates = @{
    "SSL 2.0"  = $false
    "SSL 3.0"  = $false
    "TLS 1.0"  = $tls10State
    "TLS 1.1"  = $false
    "TLS 1.2"  = $true
    "TLS 1.3"  = $true
}

# Remove TLS 1.3 if unsupported
if ([Environment]::OSVersion.Version.Major -lt 10 -or [Environment]::OSVersion.Version.Build -lt 20348) {
    $desiredStates.Remove("TLS 1.3")
}

Write-Host "`n--- Current SSL/TLS Protocol States ---" -ForegroundColor Cyan
$changes = @{}

foreach ($protocol in $desiredStates.Keys) {
    $current = Get-ProtocolState -Protocol $protocol
    $desired = $desiredStates[$protocol]

    Write-Host "`n${protocol}:"
    foreach ($role in @("Client", "Server")) {
        $enabled = $current["$role.Enabled"]
        $disabled = $current["$role.DisabledByDefault"]
        Write-Host "  $role - Enabled: $enabled, DisabledByDefault: $disabled"

        if (($desired -and ($enabled -ne 1 -or $disabled -ne 0)) -or
            (-not $desired -and ($enabled -ne 0 -or $disabled -ne 1))) {
            $changes[$protocol] = $desired
        }
    }
}

# Apply changes automatically
if ($changes.Count -eq 0) {
    Write-Host "`n✅ No changes required." -ForegroundColor Green
    Add-Content -Path $logPath -Value "$(Get-Date -Format u) - No changes required"
} else {
    Write-Host "`nApplying changes..." -ForegroundColor Yellow
    foreach ($item in $changes.GetEnumerator()) {
        Set-ProtocolState -Protocol $item.Key -Enable:$item.Value
        Write-Host "✅ Applied $($item.Key)" -ForegroundColor Green
    }
    Add-Content -Path $logPath -Value "$(Get-Date -Format u) - Protocol changes applied successfully"
    Write-Host "`n✅ All changes applied. A system reboot is required." -ForegroundColor Cyan
}

# Post-change verification output
Write-Host "`n--- Verified SSL/TLS Protocol States After Change ---" -ForegroundColor Cyan

foreach ($protocol in $desiredStates.Keys) {
    $finalState = Get-ProtocolState -Protocol $protocol
    Write-Host "`n${protocol}:"
    foreach ($role in @("Client", "Server")) {
        $enabled = $finalState["$role.Enabled"]
        $disabled = $finalState["$role.DisabledByDefault"]
        Write-Host "  $role - Enabled: $enabled, DisabledByDefault: $disabled"
    }
}

# Optional reboot (commented out for safety)
# Restart-Computer -Force
